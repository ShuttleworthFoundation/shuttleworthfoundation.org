/*!
 * BubbleTree 2.0.1
 *
 * Copyright (c) 2011 Gregor Aisch (http://driven-by-data.net)
 * Licensed under the MIT license
 *
 *//*jshint undef: true, browser:true, jquery: true, devel: true, smarttabs: true *//*global Raphael, TWEEN, vis4, vis4color, vis4loader */var BubbleTree=function(a,b,c){var d=this;d.version="2.0.2",d.$container=$(a.container),d.config=$.extend({rootPath:"",minRadiusLabels:40,minRadiusAmounts:20,minRadiusHideLabels:0,cutLabelsAt:50},a),d.tooltip=a.tooltipCallback?a.tooltipCallback:function(){},a.tooltip&&(d.tooltip=a.tooltip),d.style=a.bubbleStyles,d.ns=BubbleTree,d.nodesByUrlToken={},d.nodeList=[],d.iconsByUrlToken={},d.globalNodeCounter=0,d.displayObjects=[],d.bubbleScale=1,d.globRotation=0,d.currentYear=a.initYear,d.currentCenter=undefined,d.currentTransition=undefined,d.baseUrl="",d.loadData=function(a){$.ajax({url:a,dataType:"json",success:this.setData.bind(this)})},d.setData=function(a){var b=this;a||(a=b.config.data),b.initData(a),b.initPaper(),b.initBubbles(),b.initTween(),b.initHistory()},d.initData=function(a){var b=this;a.level=0,b.preprocessData(a),b.traverse(a,0),b.treeRoot=a},d.preprocessData=function(a){var b=this,c=b.config.maxNodesPerLevel;if(c&&c<a.children.length){var d=b.sortChildren(a.children);d.reverse();var e=[],f=[],g=0,h;for(var i in a.children)i<c?e.push(a.children[i]):(f.push(a.children[i]),g+=Math.max(0,a.children[i].amount));a.children=e,a.children.push({label:"More",name:"more",amount:g,children:f,breakdown:h})}},d.traverse=function(a,b){var c,d,e,f=this,g,h=f.config.bubbleStyles;a.children||(a.children=[]),f.nodeList.push(a),a.famount=f.ns.Utils.formatNumber(a.amount),a.parent&&(a.level=a.parent.level+1),f.config.clearColors===!0&&(a.color=!1);if(h){var i=["color","shortLabel","icon"];$.each(i,function(b,c){h.hasOwnProperty("id")&&h.id.hasOwnProperty(a.id)&&h.id[a.id].hasOwnProperty(c)?a[c]=h.id[a.id][c]:a.hasOwnProperty("name")&&h.hasOwnProperty("name")&&h.name.hasOwnProperty(a.name)&&h.name[a.name].hasOwnProperty(c)?a[c]=h.name[a.name][c]:a.hasOwnProperty("taxonomy")&&h.hasOwnProperty(a.taxonomy)&&h[a.taxonomy].hasOwnProperty(a.name)&&h[a.taxonomy][a.name].hasOwnProperty(c)&&(a[c]=h[a.taxonomy][a.name][c])})}a.color||(a.level>0?a.color=a.parent.color:a.color="#999999"),a.children.length<2&&a.color&&(a.color=vis4color.fromHex(a.color).saturation("*.86").x),a.level>0&&(e=a.parent.children,e.length>1&&(a.left=e[(b-1+e.length)%e.length],a.right=e[(Number(b)+1)%e.length],a.right==a.left&&(a.right=undefined))),a.label!==undefined&&a.label!==""?g=a.label:a.token!==undefined&&a.token!==""?g=a.token:g=""+f.globalNodeCounter,f.globalNodeCounter++,a.urlToken=g.toLowerCase().replace(/\W/g,"-");while(f.nodesByUrlToken.hasOwnProperty(a.urlToken))a.urlToken+="-";f.nodesByUrlToken[a.urlToken]=a,a.maxChildAmount=0,a.children=f.sortChildren(a.children,!0,f.config.sortBy),$.each(a.children,function(b,c){c.parent=a,a.maxChildAmount=Math.max(a.maxChildAmount,c.amount),f.traverse(c,b)}),a.breakdowns&&(a.breakdownsByName={},$.each(a.breakdowns,function(b,c){c.famount=f.ns.Utils.formatNumber(c.amount),c.name&&(a.breakdownsByName[c.name]=c)}))},d.sortChildren=function(a,b,c){var e=[],f=!0;c=="label"?(c=d.compareLabels,b=!1):c=d.compareAmounts,a.sort(c);if(b){while(a.length>0)e.push(f?a.pop():a.shift()),f=!f;return e}return a},d.compareAmounts=function(a,b){return a.amount>b.amount?1:a.amount==b.amount?0:-1},d.compareLabels=function(a,b){return a.label>b.label?1:a.label==b.label?0:-1},d.initPaper=function(){var a=this,b=a.$container,c=a.treeRoot,d=b.width(),e=b.height(),f=Raphael(b[0],d,e),g=Math.min(d,e)*.5-40,h,i=a.ns.Vector,j=new i(d*.5,e*.5);a.width=d,a.height=e,a.paper=f,h=Math.pow((Math.pow(c.amount,.6)+Math.pow(c.maxChildAmount,.6)*2)/g,1.6666666667),a.a2radBase=a.ns.a2radBase=h,a.origin=j,$(window).resize(a.onResize.bind(a))},d.onResize=function(){var a=this,b=a.$container,c=b.width(),d=b.height(),e=Math.min(c,d)*.5-40,f,g=a.treeRoot,h,i;a.paper.setSize(c,d),a.origin.x=c*.5,a.origin.y=d*.5,a.width=c,a.height=d,f=Math.pow((Math.pow(g.amount,.6)+Math.pow(g.maxChildAmount,.6)*2)/e,1.6666666667),a.a2radBase=a.ns.a2radBase=f,$.each(a.displayObjects,function(b,c){c.className=="bubble"&&(c.bubbleRad=a.ns.Utils.amount2rad(c.node.amount))}),a.currentCenter&&a.changeView(a.currentCenter.urlToken)},d.initTween=function(){this.tweenTimer=setInterval(this.loop,1e3/120)},d.initBubbles=function(){var a=this,b=a.treeRoot,c,d=!1,e=a.ns.Bubbles,f;a.bubbleClasses=[],a.config.hasOwnProperty("bubbleType")||(a.config.bubbleType=["plain"]),$.isArray(a.config.bubbleType)||(a.config.bubbleType=[a.config.bubbleType]),$.isArray(a.config.bubbleType)&&$.each(a.config.bubbleType,function(b){a.config.bubbleType[b]=="icon"&&(d=!0),a.bubbleClasses.push(a.getBubbleType(a.config.bubbleType[b]))});var g=a.createBubble(b,a.origin,0,0,b.color);a.traverseBubbles(g)},d.getBubbleType=function(a){var b=this,c=b.ns.Bubbles;switch(a){case"pie":return c.Pies;case"donut":return c.Donut;case"multi":return c.Multi;case"icon":return c.Icon;default:return c.Plain}},d.traverseBubbles=function(a){var b=this,c,d=b.ns.Utils.amount2rad,e,f,g,h,i=0,j=0,k,l,m=Math.PI*2;g=a.node.children,$.each(g,function(a,b){i+=d(b.amount)}),g.length>0&&(c=b.createRing(a.node,a.pos,0,{stroke:"#888","stroke-dasharray":"-"})),$.each(g,function(c,e){k=d(e.amount)/i*m,l=j+k*.5,isNaN(l)&&vis4.log(j,k,e.amount,i,m),e.centerAngle=l,h=b.createBubble(e,a.pos,0,l,e.color),j+=k,b.traverseBubbles(h)})},d.createBubble=function(a,b,c,d,e){var f=this,g=f.ns,h,i,j,k=a.level;isNaN(k)&&(k=0),k=Math.min(k,f.bubbleClasses.length-1),j=new f.bubbleClasses[k](a,f,b,c,d,e),f.displayObjects.push(j);return j},d.createRing=function(a,b,c,d){var e=this,f=e.ns,g;g=new f.Ring(a,e,b,c,d),e.displayObjects.push(g);return g},d.changeView=function(a){var b=this,c=b.paper,d=Math.min(b.width,b.height)*.35,e=b.ns,f=e.Utils,g=b.origin,h={stroke:"#ccc","stroke-dasharray":"- "},i={stroke:"#ccc","stroke-dasharray":". "},j=f.amount2rad,k=b.treeRoot,l=b.nodesByUrlToken,m=l.hasOwnProperty(a)?l[a]:null,n=new e.Layout,o,p,q,r=Math.PI*2,s=b.getBubble.bind(b),t=b.getRing.bind(b),u=b.unifyAngle;if(m!==null){var v,w,x,y,z,A,B,C,D,E,F,G,H,I=!1,J=!1;for(q in b.displayObjects)b.displayObjects[q].hideFlag=!0;if(m==k||m.parent==k&&m.children.length<2){n.$(b).bubbleScale=1,n.$(g).x=b.width*.5,n.$(g).y=b.height*.5,v=s(k),m!=k&&(v.childRotation=-m.centerAngle),A=j(k.amount)+j(k.maxChildAmount)+20,F=t(k),n.$(F).rad=A;for(q in k.children)z=k.children[q],o=s(z),n.$(o).angle=u(z.centerAngle+v.childRotation),n.$(o).rad=A}else{var K=m;m.children.length<2&&(m=m.parent),G=d/(j(m.amount)+j(m.maxChildAmount)*2),n.$(b).bubbleScale=G,v=s(m),b.currentCenter&&b.currentCenter==m.left?J=!0:b.currentCenter&&b.currentCenter==m.right&&(I=!0);var L=b.shortestAngleTo;n.$(v).angle=L(v.angle,0),A=(j(m.amount)+j(m.maxChildAmount))*G+20,F=t(m),n.$(F).rad=A,w=s(m.parent),w.childRotation=-m.centerAngle;var M=w;while(M&&M.node.parent)M=s(M.node.parent,!0),n.$(M).rad=0;n.$(w).rad=0;var N=b.width*.5;B=0-Math.max(N*.8-G*(j(m.parent.amount)+j(Math.max(m.amount*1.15+m.maxChildAmount*1.15,m.left.amount*.85,m.right.amount*.85))),G*j(m.parent.amount)*-1+N*.15)+N;if(m.left&&m.right)var O=G*j(Math.max(m.left.amount,m.right.amount));H=A+B,n.$(g).x=b.width*.5-B-(m!=K?A*.35:0),n.$(g).y=b.height*.5,new vis4.DelayedTask(1500,vis4,vis4.log,g,w.pos),B+=b.width*.1,F=t(m.parent),n.$(F).rad=B,n.$(v).rad=B;var P=0-(m!=K?K.centerAngle+v.childRotation:0);for(q in m.children)z=m.children[q],o=s(z),n.$(o).angle=b.shortestAngleTo(o.angle,z.centerAngle+v.childRotation+P),n.$(o).rad=A;var Q=b.height*.07;m.left&&(x=m.left,D=j(x.amount)*G,E=r-Math.asin((b.paper.height*.5+D-Q)/B),o=s(x),n.$(o).rad=B,n.$(o).angle=L(o.angle,E)),m.right&&(x=m.right,D=j(x.amount)*G,E=Math.asin((b.paper.height*.5+D-Q)/B),o=s(x),n.$(o).rad=B,n.$(o).angle=L(o.angle,E)),m=K}for(q in b.displayObjects){var R=b.displayObjects[q];R.hideFlag&&R.visible?(n.$(R).alpha=0,R.className=="bubble"&&R.node.level>1&&(n.$(R).rad=0),n.hide(R)):R.hideFlag||(n.$(R).alpha=1,R.visible||(R.alpha=0,n.show(R)))}p=new e.Transitioner($.browser.msie||b.currentCenter==m?0:1e3),p.changeLayout(n),b.currentTransition=p,!b.currentCenter&&$.isFunction(b.config.firstNodeCallback)&&b.config.firstNodeCallback(m),b.currentCenter=m}else f.log("node "+a+" not found")},d.unifyAngle=function(a){var b=Math.PI,c=b*2;while(a>=c)a-=c;while(a<0)a+=c;return a},d.shortestAngle=function(a,b){var c=function(a){return Math.round(a/Math.PI*180)+""},e=Math.PI,f=e*2,g=d.unifyAngle;a=g(a),b=g(b);var h=b-a;h>e&&(h-=f),h<-e&&(h+=f);return h},d.shortestAngleTo=function(a,b){return a+d.shortestAngle(a,b)},d.shortestLeftTurn=function(a,b){var c=d.shortestAngle(a,b);c>0&&(c=c-Math.PI*2);return a+c},d.shortestRightTurn=function(a,b){var c=d.shortestAngle(a,b);c<0&&(c=Math.PI*2+c);return a+c},d.getBubble=function(a,b){return this.getDisplayObject("bubble",a,b)},d.getRing=function(a){return this.getDisplayObject("ring",a)},d.getDisplayObject=function(a,b,c){var d=this,e,f;for(e in d.displayObjects){f=d.displayObjects[e];if(f.className!=a)continue;if(f.node==b){c||(f.hideFlag=!1);return f}}vis4.log(a+" not found for node",b)},d.initHistory=function(){$.history.init(d.urlChanged.bind(d),{unescape:",/"})},d.freshUrl="",d.urlChanged=function(a){var b=this,c=b.currentTransition;b.freshUrl||a.indexOf("/~/")&&(b.baseUrl=a.substr(0,a.indexOf("/~/"))),b.freshUrl=a,c&&c.running?(vis4.log("transition is running at the moment, adding listener"),c.onComplete(b.changeUrl.bind(b))):b.changeUrl()},d.changeUrl=function(){var a=this,b=a.freshUrl.split("/"),c=b[b.length-1],d;a.freshUrl===""&&a.navigateTo(a.treeRoot),a.nodesByUrlToken.hasOwnProperty(c)?(d=a.getUrlForNode(a.nodesByUrlToken[c]),a.freshUrl!=d?$.history.load(d):a.navigateTo(a.nodesByUrlToken[c],!0)):a.navigateTo(a.treeRoot)},d.navigateTo=function(a,b){var c=this;b?c.changeView(a.urlToken):$.history.load(c.getUrlForNode(a)),$(".label, .label2",c.$container).removeClass("current"),$(".label2."+a.id,c.$container).addClass("current"),$(".label."+a.id,c.$container).addClass("current")},d.getUrlForNode=function(a){var b=[];b.push(a.urlToken);while(a.parent)b.push(a.parent.urlToken),a=a.parent;b.reverse();return d.baseUrl+"/~/"+b.join("/")},d.onNodeClick=function(a){$.isFunction(d.config.nodeClickCallback)&&d.config.nodeClickCallback(a)},d.clean=function(){var a=this,b;$(".label").remove()},this.loop=function(){TWEEN.update()};if(!d.config.hasOwnProperty("data"))throw new Error("no data");typeof d.config.data=="string"?d.loadData():new vis4.DelayedTask(1e3,d,d.setData,d.config.data)};BubbleTree.Styles={},BubbleTree.Layout=function(){var a=this;a.objects=[],a.props=[],a.toHide=[],a.toShow=[],a.$=function(a){var b=this,c,d,e;for(c in b.objects){d=b.objects[c];if(d==a)return b.props[c]}b.objects.push(a),e={},b.props.push(e);return e},a.show=function(a){var b=this;b.toShow.push(a)},a.hide=function(a){var b=this;b.toHide.push(a)}},BubbleTree.Line=function(a,b,c,d,e,f){this.bc=a,this.o=c,this.angle=d,this.fromRad=e,this.attr=b,this.toRad=f,this.getXY=function(){this.x1=this.o.x+Math.cos(this.angle)*this.fromRad,this.y1=this.o.y-Math.sin(this.angle)*this.fromRad,this.x2=this.o.x+Math.cos(this.angle)*this.toRad,this.y2=this.o.y-Math.sin(this.angle)*this.toRad},this.init=function(){this.getXY(),console.log("foo","M"+this.x1+" "+this.y1+"L"+this.x2+" "+this.y2,b),this.path=this.bc.paper.path("M"+this.x1+" "+this.y1+"L"+this.x2+" "+this.y2).attr(this.attr)},this.draw=function(){this.getXY(),this.path.attr({path:"M"+this.x1+" "+this.y1+"L"+this.x2+" "+this.y2})},this.init()},BubbleTree.Loader=function(a){var b=this;b.config=a,b.ns=BubbleTree,b.loadData=function(){var a=this,b=a.config.data;console.log("loading url ",b),$.ajax({url:b,context:a,dataType:"json",success:function(a){this.run(a)}})},b.run=function(a){var b=this,c=new BubbleTree(b.config);c.setData(a),b.config.instance=c},!!b.config.hasOwnProperty("data"),typeof b.config.data=="string"?b.loadData():b.run(b.config.data)},BubbleTree.MouseEventGroup=function(a,b){var c=this;c.target=a,c.members=b,c.click=function(a){var b=this,c=b.members,d,e;b.clickCallback=a;for(d in c)e=c[d],$(e).click(b.handleClick.bind(b))},c.handleClick=function(a){var b=this;b.clickCallback({target:b.target,origEvent:a,mouseEventGroup:b})},c.hover=function(a){var b=this,c=b.members,d,e;b.hoverCallback=a;for(d in c)e=c[d],$(e).hover(b.handleMemberHover.bind(b),b.handleMemberUnHover.bind(b))},c.unhover=function(a){var b=this;b.unhoverCallback=a},c.wasHovering=!1,c.mouseIsOver=!1,c.handleMemberHover=function(a){var b=this;new vis4.DelayedTask(25,b,b.handleMemberHoverDelayed,a)},c.handleMemberHoverDelayed=function(a){var b=this;b.mouseIsOver=!0,b.wasHovering||(b.wasHovering=!0,$.isFunction(b.hoverCallback)&&b.hoverCallback({target:b.target,origEvent:a,mouseEventGroup:b}))},c.handleMemberUnHover=function(a){var b=this;b.mouseIsOver=!1,new vis4.DelayedTask(40,b,b.handleMemberUnHoverDelayed,a)},c.handleMemberUnHoverDelayed=function(a){var b=this;b.mouseIsOver||(b.wasHovering=!1,$.isFunction(b.unhoverCallback)&&b.unhoverCallback({target:b.target,origEvent:a,mouseEventGroup:b}))},c.addMember=function(a){var b=this;b.hoverCallback&&$(a).hover(b.handleMemberHover.bind(b),b.handleMemberUnHover.bind(b)),b.members.push(a)},c.removeMember=function(a){var b=this,c=b.members,d,e=[];b.clickCallback&&$(a).unbind("click"),b.hoverCallback&&$(a).unbind("mouseenter mouseleave");for(d in c)c[d]!=a&&e.push(c[d]);b.members=e}},BubbleTree.Ring=function(a,b,c,d,e){var f=this;f.className="ring",f.rad=d,f.bc=b,f.attr=e,f.origin=c,f.alpha=1,f.visible=!1,f.node=a,f.init=function(){},f.draw=function(){var a=this,b=a.origin;!a.visible||a.circle.attr({cx:b.x,cy:b.y,r:a.rad,"stroke-opacity":a.alpha})},f.hide=function(){var a=this;a.circle.remove(),a.visible=!1},f.show=function(){var a=this;a.circle=a.bc.paper.circle(c.x,c.y,a.rad).attr(a.attr),a.visible=!0,a.circle.toBack()},f.init()},BubbleTree.Transitioner=function(a){var b=this;b.duration=a,b.running=!1,b.completeCallbacks=[],b.changeLayout=function(a){var b,c,d,e,f=this;f.running=!0,f.layout=a;for(b in a.toShow)c=a.toShow[b],$.isFunction(c.show)&&c.show();for(b in a.objects){c=a.objects[b];if(c===undefined||c===null)continue;d=a.props[b];if(f.duration>0){var g=new TWEEN.Tween(c),h={};for(e in d)h[e]=d[e];g.to(h,f.duration),g.easing(TWEEN.Easing.Exponential.EaseOut),$.isFunction(c.draw)&&g.onUpdate(c.draw.bind(c)),b==a.objects.length-1&&g.onComplete(f._completed.bind(f)),g.start()}else{for(e in d)c[e]=d[e];c&&$.isFunction(c.draw)&&c.draw()}}if(f.duration===0){for(b in a.objects)c=a.objects[b],c&&$.isFunction(c.draw)&&c.draw();f._completed()}},b.onComplete=function(a){var b=this;try{$.isFunction(a)&&b.completeCallbacks.push(a)}catch(c){}},b._completed=function(){var a=this,b=a.completeCallbacks,c,d;a.running=!1;for(c in a.layout.objects)d=a.layout.objects[c],d&&$.isFunction(d.draw)&&d.draw();for(c in a.layout.toHide)d=a.layout.toHide[c],d&&$.isFunction(d.hide)&&d.hide();for(c in b)b[c]()}},BubbleTree.Utils={},BubbleTree.Utils.log=function(){try{window.hasOwnProperty("console")&&console.log.apply(this,arguments)}catch(a){}},BubbleTree.Utils.amount2rad=function(a){return Math.pow(Math.max(0,a)/BubbleTree.a2radBase,.6)},BubbleTree.Utils.formatNumber=function(a){var b="";a<0&&(a=a*-1,b="-");return a>=1e12?b+Math.round(a/1e11)/10+"t":a>=1e9?b+Math.round(a/1e8)/10+"b":a>=1e6?b+Math.round(a/1e5)/10+"m":a>=1e3?b+Math.round(a/100)/10+"k":b+a},BubbleTree.Vector=function(a,b){var c=this;c.x=a,c.y=b,c.length=function(){var a=this;return Math.sqrt(a.x*a.x+a.y*a.y)},c.normalize=function(a){var b=this,c=b.length();a||(a=1),b.x*=a/c,b.y*=a/c},c.clone=function(){var a=this;return new BubbleTree.Vector(a.x,a.y)}},BubbleTree.Bubbles=BubbleTree.Bubbles||{},BubbleTree.Bubbles.Plain=function(a,b,c,d,e,f){var g=BubbleTree,h=g.Utils,i=this;i.className="bubble",i.node=a,i.paper=b.paper,i.origin=c,i.bc=b,i.rad=d,i.angle=e,i.color=f,i.alpha=1,i.visible=!1,i.ns=g,i.pos=g.Vector(0,0),i.bubbleRad=h.amount2rad(this.node.amount),i.container=i.bc.$container,i.childRotation=0,i.getXY=function(){var a=this,b=a.origin,c=a.angle,d=a.rad;a.pos===undefined&&(a.pos=new a.ns.Vector(0,0)),a.pos.x=b.x+Math.cos(c)*d,a.pos.y=b.y-Math.sin(c)*d},i.init=function(){var a=this;a.getXY();var b=!1;a.node.shortLabel||(a.node.shortLabel=a.node.label.length>a.bc.config.cutLabelsAt+3?a.node.label.substr(0,a.bc.config.cutLabelsAt)+"...":a.node.label),a.initialized=!0},i.onclick=function(a){var b=this;b.bc.onNodeClick(b.node),b.bc.navigateTo(b.node)},i.onhover=function(a){var b=this,c=b.bc.$container[0];a.node=b.node,a.target=b,a.bubblePos={x:b.pos.x,y:b.pos.y},a.mousePos={x:a.origEvent.pageX-c.offsetLeft,y:a.origEvent.pageY-c.offsetTop},a.type="SHOW",b.bc.tooltip(a)},i.onunhover=function(a){var b=this,c=b.bc.$container[0];a.node=b.node,a.type="HIDE",a.target=b,a.bubblePos={x:b.pos.x,y:b.pos.y},a.mousePos={x:a.origEvent.pageX-c.offsetLeft,y:a.origEvent.pageY-c.offsetTop},b.bc.tooltip(a)},i.draw=function(){var a=this,b=Math.max(5,a.bubbleRad*a.bc.bubbleScale),c=a.pos.x,d=a.pos.y,e=a.getXY(),f=a.pos.x,g=a.pos.y;if(!!a.visible){a.circle.attr({cx:a.pos.x,cy:a.pos.y,r:b,"fill-opacity":a.alpha}),a.node.children.length>1?a.dashedBorder.attr({cx:a.pos.x,cy:a.pos.y,r:b-4,"stroke-opacity":a.alpha*.9}):a.dashedBorder.attr({"stroke-opacity":0}),a.label.show(),a.label.find("*").show(),a.label2.show(),b>=a.bc.config.minRadiusLabels?a.label2.hide():b>=a.bc.config.minRadiusAmounts?a.label.find(".desc").hide():b>=a.bc.config.minRadiusHideLabels?a.label.hide():(a.label.hide(),a.label2.hide()),a.label.css({width:2*b+"px",opacity:a.alpha}),a.label.css({left:a.pos.x-b+"px",top:a.pos.y-a.label.height()*.5+"px"});var h=Math.max(70,3*b);a.label2.css({width:h+"px",opacity:a.alpha}),a.label2.css({left:f-h*.5+"px",top:g+b+"px"})}},i.hide=function(){var a=this,b;a.circle.remove(),a.dashedBorder.remove(),a.label.remove(),a.label2.remove(),a.visible=!1},i.show=function(){var a=this,b,c=a.pos.x,d=a.pos.y,e=Math.max(5,a.bubbleRad*a.bc.bubbleScale);a.circle=a.paper.circle(c,d,e).attr({stroke:!1,fill:a.color}),a.dashedBorder=a.paper.circle(c,d,e-3).attr({stroke:"#ffffff","stroke-dasharray":"- "}),a.label=$('<div class="label '+a.node.id+'"><div class="amount">'+h.formatNumber(a.node.amount)+'</div><div class="desc">'+a.node.shortLabel+"</div></div>"),a.container.append(a.label),a.node.children.length>0&&($(a.circle.node).css({cursor:"pointer"}),$(a.label).css({cursor:"pointer"})),a.label2=$('<div class="label2 '+a.node.id+'"><span>'+a.node.shortLabel+"</span></div>"),a.container.append(a.label2);var f=[a.circle.node,a.label,a.dashedBorder.node],g=new a.ns.MouseEventGroup(a,f);g.click(a.onclick.bind(a)),g.hover(a.onhover.bind(a)),g.unhover(a.onunhover.bind(a)),a.visible=!0},i.addOverlay=function(){var a=this;a.overlay=a.paper.circle(a.circle.attrs.cx,a.circle.attrs.cy,a.circle.attrs.r).attr({stroke:!1,fill:"#fff",opacity:0}),Raphael.svg&&a.overlay.node.setAttribute("class",a.node.id),$(a.overlay.node).css({cursor:"pointer"}),$(a.overlay.node).click(a.onclick.bind(a)),$(a.label).click(a.onclick.bind(a))},i.init()},BubbleTree.Bubbles=BubbleTree.Bubbles||{},BubbleTree.Bubbles.Donut=function(a,b,c,d,e,f){var g=BubbleTree,h=g.Utils,i=this;i.className="bubble",i.node=a,i.paper=b.paper,i.origin=c,i.bc=b,i.rad=d,i.angle=e,i.color=f,i.alpha=1,i.visible=!1,i.ns=g,i.bubbleRad=h.amount2rad(this.node.amount),i.childRotation=0,i.getXY=function(){var a=this,b=a.origin,c=a.angle,d=a.rad;a.pos.x=b.x+Math.cos(c)*d,a.pos.y=b.y-Math.sin(c)*d},i.init=function(){var a=this;a.pos=new a.ns.Vector(0,0),a.getXY();var b=[],c,d,e,f=[],g=a.bc.config.bubbleStyles;a.node.shortLabel||(a.node.shortLabel=a.node.label.length>50?a.node.label.substr(0,30)+"...":a.node.label),a.breakdownOpacities=[.2,.7,.45,.6,.35],a.breakdownColors=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1];for(d in a.node.breakdowns)c=a.node.breakdowns[d],c.famount=h.formatNumber(c.amount),e=c.amount/a.node.amount,b.push(e),f.push(c),g&&g.hasOwnProperty("name")&&g.name.hasOwnProperty(c.name)&&g.name[c.name].hasOwnProperty("opacity")&&(a.breakdownOpacities[f.length-1]=g.name[c.name].opacity),g&&g.hasOwnProperty("name")&&g.name.hasOwnProperty(c.name)&&g.name[c.name].hasOwnProperty("color")&&(a.breakdownColors[f.length-1]=g.name[c.name].color,a.breakdownOpacities[f.length-1]=1);a.node.breakdowns=f,a.breakdown=b;var i=!1;a.initialized=!0},i.onclick=function(a){var b=this;b.bc.navigateTo(b.node)},i.onhover=function(a){var b=this,c=b.bc.$container[0];a.node=b.node,a.target=b,a.bubblePos={x:b.pos.x,y:b.pos.y},a.mousePos={x:a.origEvent.pageX-c.offsetLeft,y:a.origEvent.pageY-c.offsetTop},a.type="SHOW",b.bc.tooltip(a)},i.onunhover=function(a){var b=this,c=b.bc.$container[0];a.node=b.node,a.target=b,a.type="HIDE",a.bubblePos={x:b.pos.x,y:b.pos.y},a.mousePos={x:a.origEvent.pageX-c.offsetLeft,y:a.origEvent.pageY-c.offsetTop},b.bc.tooltip(a)},this.draw=function(){var a=this,b=Math.max(5,a.bubbleRad*a.bc.bubbleScale),c=a.pos.x,d=a.pos.y,e=a.getXY(),f=b>20,g=a.pos.x,h=a.pos.y;if(!!a.visible){a.circle.attr({cx:g,cy:h,r:b,"fill-opacity":a.alpha}),a.node.children.length>1?a.dashedBorder.attr({cx:g,cy:h,r:b*.85,"stroke-opacity":a.alpha*.8}):a.dashedBorder.attr({"stroke-opacity":0});if(a.breakdown.length>1){var i,j,k,l,m,n,o,p,q,r=b*.85,s=-Math.PI*.5,t;for(i in a.breakdown){t=a.breakdown[i]*Math.PI*2,j=g+Math.cos(s)*r,n=h+Math.sin(s)*r,k=g+Math.cos(s+t)*r,o=h+Math.sin(s+t)*r,l=g+Math.cos(s+t)*b,p=h+Math.sin(s+t)*b,m=g+Math.cos(s)*b,q=h+Math.sin(s)*b,s+=t;var u="M"+j+" "+n+" A"+r+","+r+" 0 "+(t>Math.PI?"1,1":"0,1")+" "+k+","+o+" L"+l+" "+p+" A"+b+","+b+" 0 "+(t>Math.PI?"1,0":"0,0")+" "+m+" "+q+" Z";a.breakdownArcs[i].attr({path:u,"stroke-opacity":a.alpha*.2,"fill-opacity":a.breakdownOpacities[i]*a.alpha})}}f?(a.label.show(),b<40?(a.label.find(".desc").hide(),a.label2.show()):(a.label.find(".desc").show(),a.label2.hide())):(a.label.hide(),a.label2.show()),a.label.css({width:2*b*.9+"px",opacity:a.alpha}),a.label.css({left:a.pos.x-b*.9+"px",top:a.pos.y-a.label.height()*.53+"px"});var v=Math.max(80,3*b);a.label2.css({width:v+"px",opacity:a.alpha}),a.label2.css({left:g-v*.5+"px",top:h+b+"px"})}},this.hide=function(){var a=this,b;a.circle.remove(),a.dashedBorder.remove(),a.label.remove(),a.label2.remove(),a.visible=!1;for(b in a.breakdownArcs)a.breakdownArcs[b].remove()},i.show=function(){var a=this,b,c=Math.max(5,a.bubbleRad*a.bc.bubbleScale);a.circle=a.paper.circle(a.pos.x,a.pos.y,c).attr({stroke:!1,fill:a.color}),$.isFunction(a.bc.config.initTooltip)&&a.bc.config.initTooltip(a.node,a.circle.node),a.dashedBorder=a.paper.circle(a.pos.x,a.pos.y,c*.85).attr({stroke:"#fff","stroke-opacity":a.alpha*.4,"stroke-dasharray":". ",fill:!1}),a.label=$('<div class="label '+a.node.id+'"><div class="amount">'+h.formatNumber(a.node.amount)+'</div><div class="desc">'+a.node.shortLabel+"</div></div>"),a.bc.$container.append(a.label),a.node.children.length>1&&($(a.circle.node).css({cursor:"pointer"}),$(a.label).css({cursor:"pointer"})),a.label2=$('<div class="label2 '+a.node.id+'"><span>'+a.node.shortLabel+"</span></div>"),a.bc.$container.append(a.label2);var d=[a.circle.node,a.label];if(a.breakdown.length>1){a.breakdownArcs={};for(b in a.breakdown){var e=a.breakdownColors[b]?a.breakdownColors[b]:"#fff",f=a.paper.path("M 0 0 L 2 2").attr({fill:e,"fill-opacity":Math.random()*.4+.3,stroke:"#fff"});a.breakdownArcs[b]=f,$.isFunction(a.bc.config.initTooltip)&&a.bc.config.initTooltip(a.node.breakdowns[b],f.node)}for(b in a.breakdownArcs)$(a.breakdownArcs[b].node).click(a.onclick.bind(a))}var g=new a.ns.MouseEventGroup(a,d);g.click(a.onclick.bind(a)),g.hover(a.onhover.bind(a)),g.unhover(a.onunhover.bind(a)),a.visible=!0},i.arcHover=function(a){var b=this,c=b.bc.$container[0],d,e=b.breakdownArcs,f,g=b.node.breakdowns;for(d in e)if(e[d].node==a.target){a.node=g[d],a.bubblePos={x:b.pos.x,y:b.pos.y},a.mousePos={x:a.pageX-c.offsetLeft,y:a.pageY-c.offsetTop},a.target=b,a.type="SHOW",b.bc.tooltip(a);return}vis4.log("cant find the breakdown node")},i.arcUnhover=function(a){var b=this,c=b.bc.$container[0],d,e=b.breakdownArcs,f,g=b.node.breakdowns;for(d in e)if(e[d].node==a.target){a.node=g[d],a.bubblePos={x:b.pos.x,y:b.pos.y},a.mousePos={x:a.pageX-c.offsetLeft,y:a.pageY-c.offsetTop},a.type="HIDE",a.target=b,b.bc.tooltip(a);return}vis4.log("cant find the breakdown node")},i.init()},BubbleTree.Bubbles=BubbleTree.Bubbles||{},BubbleTree.Bubbles.Icon=function(a,b,c,d,e,f){var g=BubbleTree,h=g.Utils,i=this;i.className="bubble",i.node=a,i.paper=b.paper,i.origin=c,i.bc=b,i.rad=d,i.angle=e,i.color=f,i.alpha=1,i.visible=!1,i.ns=g,i.pos=g.Vector(0,0),i.bubbleRad=h.amount2rad(this.node.amount),i.iconLoaded=!1,i.childRotation=0,i.getXY=function(){var a=this,b=a.origin,c=a.angle,d=a.rad;a.pos===undefined&&(a.pos=new a.ns.Vector(0,0)),a.pos.x=b.x+Math.cos(c)*d,a.pos.y=b.y-Math.sin(c)*d},i.init=function(){var a=this;a.getXY(),a.hasIcon=a.node.hasOwnProperty("icon"),a.node.shortLabel||(a.node.shortLabel=a.node.label.length>50?a.node.label.substr(0,30)+"...":a.node.label),a.initialized=!0},i.show=function(){var a=this,b,c=a.pos.x,d,e=a.pos.y,f=Math.max(5,a.bubbleRad*a.bc.bubbleScale);a.circle=a.paper.circle(c,e,f).attr({stroke:!1,fill:a.color}),a.dashedBorder=a.paper.circle(c,e,Math.min(f-3,f*.95)).attr({stroke:"#ffffff","stroke-dasharray":"- "}),$.isFunction(a.bc.config.initTooltip)&&a.bc.config.initTooltip(a.node,a.circle.node),a.label=$('<div class="label '+a.node.id+'"><div class="amount">'+h.formatNumber(a.node.amount)+'</div><div class="desc">'+a.node.shortLabel+"</div></div>"),a.bc.$container.append(a.label),$.isFunction(a.bc.config.initTooltip)&&a.bc.config.initTooltip(a.node,a.label[0]),a.label2=$('<div class="label2 '+a.node.id+'"><span>'+a.node.shortLabel+"</span></div>"),a.bc.$container.append(a.label2),a.node.children.length>0&&($(a.circle.node).css({cursor:"pointer"}),$(a.label).css({cursor:"pointer"})),a.visible=!0,a.hasIcon?a.iconLoaded?a.displayIcon():a.loadIcon():a.addOverlay()},i.loadIcon=function(){var a=this,b=new vis4loader;b.add(a.bc.config.rootPath+a.node.icon),b.load(a.iconLoadComplete.bind(a))},i.iconLoadComplete=function(a){var b=this,c,d,e;c=a.items[0].data,b.iconPathData="",c=$(c),e=$("path",c);for(d in e)e[d]&&$.isFunction(e[d].getAttribute)&&(b.iconPathData+=String(e[d].getAttribute("d"))+" ");b.iconLoaded=!0,b.displayIcon()},i.displayIcon=function(){var a=this,b,c;a.iconPaths=[],c=a.paper.path(a.iconPathData),c.attr({fill:"#fff",stroke:"none"}).translate(-50,-50),a.iconPaths.push(c),a.addOverlay()},i.addOverlay=function(){var a=this;a.overlay=a.paper.circle(a.circle.attrs.cx,a.circle.attrs.cy,a.circle.attrs.r).attr({stroke:!1,fill:"#fff","fill-opacity":0}),Raphael.svg&&a.overlay.node.setAttribute("class",a.node.id),$(a.overlay.node).css({cursor:"pointer"}),$(a.overlay.node).click(a.onclick.bind(a)),$(a.label).click(a.onclick.bind(a)),$(a.label2).click(a.onclick.bind(a));if($.isPlainObject(a.bc.tooltip)){var b=a.bc.tooltip.content(a.node);$(a.overlay.node).qtip({position:{target:"mouse",viewport:$(window),adjust:{x:7,y:7}},show:{delay:a.bc.tooltip.delay||100},content:{title:b[0],text:b[1]}})}},i.removeIcon=function(){var a=this,b,c;for(b in a.iconPaths)a.iconPaths[b].remove();a.iconPaths=[]},i.draw=function(){var a=this,b=Math.max(5,a.bubbleRad*a.bc.bubbleScale),c=a.pos.x,d=a.pos.y,e=a.getXY(),f=a.pos.x,g=a.pos.y,h=a.hasIcon&&b>15,i=a.hasIcon?b>40:b>20,j,k,l,m,n;if(!!a.visible){a.circle.attr({cx:f,cy:g,r:b,"fill-opacity":a.alpha}),a.overlay&&a.overlay.attr({cx:f,cy:g,r:Math.max(10,b)}),a.node.children.length>1?a.dashedBorder.attr({cx:a.pos.x,cy:a.pos.y,r:Math.min(b-3,b-4),"stroke-opacity":a.alpha*.9}):a.dashedBorder.attr({"stroke-opacity":0}),i?(a.label.show(),h&&b<70||!h&&b<40?(a.label.find(".desc").hide(),a.label2.show()):(a.label.find(".desc").show(),a.label2.hide())):(a.label.hide(),a.label2.show()),n=h?g+b*.77-a.label.height():g-a.label.height()*.5,a.label.css({width:(h?b*1.2:2*b)+"px",opacity:a.alpha}),a.label.css({left:(h?f-b*.6:f-b)+"px",top:n+"px"});var o=Math.max(80,3*b);a.label2.css({width:o+"px",opacity:a.alpha}),a.label2.css({left:f-o*.5+"px",top:g+b+"px"});if(a.hasIcon)if(h){l=(b-(i?a.label.height()*.5:0))/60;for(j in a.iconPaths)k=a.iconPaths[j],Raphael.version[0]=="1"?m="scale("+l+") translate("+f/l+", "+(g+(i?a.label.height()*-0.5:0))/l+")":m="scale("+l+") translate("+(f/l-50)+", "+((g+(i?a.label.height()*-0.5:0))/l-50)+")",k.node.setAttribute("transform",m),k.attr({"fill-opacity":a.alpha})}else for(j in a.iconPaths)k=a.iconPaths[j],k.attr({"fill-opacity":0})}},i.hide=function(){var a=this,b;a.circle.remove(),a.dashedBorder.remove(),a.label.remove(),a.label2.remove(),a.visible=!1,a.hasIcon&&a.removeIcon(),a.overlay&&a.overlay.remove()},i.onclick=function(a){var b=this;b.bc.onNodeClick(b.node),b.bc.navigateTo(b.node)},i.onhover=function(a){var b=this,c=b.bc.$container[0];a.node=b.node,a.bubblePos={x:b.pos.x,y:b.pos.y},a.mousePos={x:a.origEvent.pageX-c.offsetLeft,y:a.origEvent.pageY-c.offsetTop},a.type="SHOW",a.target=b,b.bc.tooltip(a)},i.onunhover=function(a){var b=this,c=b.bc.$container[0];a.node=b.node,a.type="HIDE",a.target=b,a.bubblePos={x:b.pos.x,y:b.pos.y},a.mousePos={x:a.origEvent.pageX-c.offsetLeft,y:a.origEvent.pageY-c.offsetTop},b.bc.tooltip(a)},i.init()}